---
title: "useR2018"
author: "@mdneuzerling"
date: "2018-08-17"
output:
  xaringan::moon_reader:
    seal: false # disable title slide
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---



```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(cache = TRUE)
```


class: center, middle

# David Neuzerling
## 2018-08-17

<img src="hex/hexwall.jpg" style="width: 45%; height: 45%;"></img>

---
class: inverse, center, middle

<img src="hex/r2d3.jpg" style="width: 45%; height: 45%;"></img>   <img src="hex/recipes.jpg" style="width: 45%; height: 45%;"></img>

---
class: inverse, center, middle

# R vs. Python

![Fighting corgis](https://i.imgur.com/NzppaUe.gif)

---
class: left
## R-fresher: Ceci **est** pas une pipe

`%>%` is a *pipe*. It puts the object on the left into the *first* argument of
the function on the right:

* `4 %>% sqrt` is the same as `sqrt(4)`
* `data %>% head` is the same as `head(data)`

Or, if we wanted to calculate the average BMI of all droids in the Star Wars movies:

```{r starwars_piped, eval = FALSE}
starwars %>% 
    filter(species == "Droid") %>%
    mutate(BMI = mass / (height / 100)^2) %>% 
    summarise(avg_BMI = mean(BMI, na.rm = TRUE))
```

is the same as

```{r avg_droid_mass, eval = FALSE}
summarise(mutate(filter(starwars, species == "Droid"), BMI = mass / (height / 100)^2), avg_BMI = mean(BMI, na.rm = TRUE))
```

It's 32.7.

---
class: center, middle

## R-fresher: visualisation

```{r bomrang_plot_data, echo = FALSE, warning = FALSE, message = FALSE}
library(tidyverse)
library(bomrang)

weather <- get_historical(
    stationid = "090015",
    type = "max"
)
```

```{r bomrang_plot, echo = FALSE, warning = FALSE, message = FALSE}
weather_plot <- weather %>% 
    filter(!is.na(Max_temperature)) %>% # remove missing values  
    mutate(
        Season = case_when(
            Month %in% c(12, 1, 2) ~ "Summer",
            Month %in% c(3, 4, 5) ~ "Autumn",
            Month %in% c(6, 7, 8) ~ "Winter",
            Month %in% c(9, 10, 11) ~ "Spring"
        ),
        Season = factor(Season, levels = c("Summer", "Autumn", "Winter", "Spring")) # ordering
    ) %>%
    group_by(Year, Season) %>% 
    summarise(Average_max_temp = mean(Max_temperature)) %>% 
    ggplot(aes(x = Year, y = Average_max_temp)) +  
        geom_point() +
        geom_smooth() + 
        facet_grid(Season ~ .) +
        ggtitle("Cape Otway Lighthouse seasonal temperatures")
```

```{r bomrang_plotly, echo = FALSE, warning = FALSE, message = FALSE}
library(plotly)
library(widgetframe)    
weather_plotly <- weather_plot %>% 
    ggplotly(height = 450) %>% 
    config(displayModeBar = F)
frameWidget(weather_plotly)
```

---
class: left
## R-fresher: visualisation code

```{r bomrang_plot_data_code, eval = FALSE}
library(tidyverse)
library(bomrang)

weather <- get_historical(
    stationid = "090015",
    type = "max"
)
```

```{r bomrang_plot_data_head}
weather %>% 
    select(Station_number, Year, Month, Day, Max_temperature) %>% 
    sample_n(6)
```

---
class: left
## R-fresher: visualisation code

```{r weather_code_1, eval = FALSE}
weather %>% 
    filter(!is.na(Max_temperature))
```

---
class: left
## R-fresher: visualisation code

```{r weather_code_2, eval = FALSE}
weather %>% 
    filter(!is.na(Max_temperature)) %>%  
    mutate(
        Season = case_when(
            Month %in% c(12, 1, 2) ~ "Summer",
            Month %in% c(3, 4, 5) ~ "Autumn",
            Month %in% c(6, 7, 8) ~ "Winter",
            Month %in% c(9, 10, 11) ~ "Spring"
        ),
        Season = factor(Season, levels = c("Summer", "Autumn", "Winter", "Spring")) # ordering
    )
```

---
class: left
## R-fresher: visualisation code

```{r weather_summarised, eval = TRUE}
weather %>% 
    filter(!is.na(Max_temperature)) %>%
    mutate(
        Season = case_when(
            Month %in% c(12, 1, 2) ~ "Summer",
            Month %in% c(3, 4, 5) ~ "Autumn",
            Month %in% c(6, 7, 8) ~ "Winter",
            Month %in% c(9, 10, 11) ~ "Spring"
        ),
        Season = factor(Season, levels = c("Summer", "Autumn", "Winter", "Spring")) # ordering
    ) %>%
    group_by(Year, Season) %>% 
    summarise(Average_max_temp = mean(Max_temperature)) -> weather_summarised
```

--
```{r weather_summarised_head}
weather_summarised %>% head(1)
```

---
class: left
## R-fresher: visualisation code

.pull-left[
```{r weather_partial_plot_code_1, eval = FALSE}
weather_summarised %>% 
    ggplot(
      aes(x = Year, y = Average_max_temp)
    )
```
]

.pull-right[
```{r weather_partial_plot_1, echo = FALSE, dpi = 300, out.height = 420, out.width = 420}
weather_summarised %>% 
    ggplot(
      aes(x = Year, y = Average_max_temp)
    )
```
]

---
class: left
## R-fresher: visualisation code

.pull-left[
```{r weather_partial_plot_code_2, eval = FALSE}
weather_summarised %>% 
    ggplot(
      aes(x = Year, y = Average_max_temp)
    ) +
    geom_point()
```
]

.pull-right[
```{r weather_partial_plot_2, echo = FALSE, dpi = 300, out.height = 420, out.width = 420, warning = FALSE, message = FALSE}
weather_summarised %>% 
    ggplot(
      aes(x = Year, y = Average_max_temp)
    ) +
    geom_point()
```
]

---
class: left
## R-fresher: visualisation code

.pull-left[
```{r weather_partial_plot_code_3, eval = FALSE}
weather_summarised %>% 
    ggplot(
      aes(x = Year, y = Average_max_temp)
    ) +
    geom_point() +
    geom_smooth()
```
]

.pull-right[
```{r weather_partial_plot_3, echo = FALSE, dpi = 300, out.height = 420, out.width = 420, warning = FALSE, message= FALSE}
weather_summarised %>% 
    ggplot(
      aes(x = Year, y = Average_max_temp)
    ) +
    geom_point() +
    geom_smooth()
```
]

---
class: left
## R-fresher: visualisation code

.pull-left[
```{r weather_partial_plot_code_4, eval = FALSE}
weather_summarised %>% 
    ggplot(
      aes(x = Year, y = Average_max_temp)
    ) +
    geom_point() +
    geom_smooth() + 
    facet_grid(Season ~ .)
```

We can pass this to plotly with the `ggplotly` function.
]

.pull-right[
```{r weather_partial_plot_4, echo = FALSE, dpi = 300, out.height = 420, out.width = 420, warning = FALSE, message = FALSE}
weather_summarised %>% 
    ggplot(
      aes(x = Year, y = Average_max_temp)
    ) +
    geom_point() +
    geom_smooth() + 
    facet_grid(Season ~ .)
```
]

---
class: left

## Modifying data with recipes

* Centering
* Scaling
* Filters
* PCA
* Encoding/decoding
* Missing value imputation
* Feature engineering

```{r library_recipes, warning = FALSE, message = FALSE}
library(recipes)
```

---
## `ames` housing data

.pull-left[
```{r ames_data, include = FALSE}
ames <- AmesHousing::make_ames()
```

```{r ames_leaflet, warning = FALSE, message = FALSE, eval = FALSE}
library(leaflet)

colour_palette <- colorNumeric(
    palette = colorRampPalette(
            c('yellow', 'red')
        )(length(ames$Sale_Price)), 
    domain = ames$Sale_Price
)

leaflet(ames) %>% 
    addTiles() %>% 
    addCircleMarkers(
        radius = 2, 
        color = colour_palette(
            ames$Sale_Price
        )
    )
```
]

.pull-right[
```{r ames_leaflet_code, echo = FALSE, message = FALSE, warning = FALSE, out.height = 420, out.width = 420}
library(leaflet)

colour_palette <- colorNumeric(
  palette = colorRampPalette(c('yellow', 'red'))(length(ames$Sale_Price)), 
  domain = ames$Sale_Price
)

leaflet(ames) %>% 
    addTiles() %>% 
    addCircleMarkers(radius = 1, color = colour_palette(ames$Sale_Price))
```
]

---
## Infrequently occurring levels

.pull-left[
```{r neighbourhood_plot_code, eval = FALSE}
ames %>% 
    ggplot(aes(x = Neighborhood)) +
    geom_bar(
        fill = "#6d1e3b", 
        colour = "white"
    ) + 
    coord_flip()
```    
]

.pull-right[
```{r neighbourhood_plot, echo = FALSE, dpi = 300, out.height = 420, out.width = 420}
ames %>% 
    ggplot(aes(x = Neighborhood)) +
    geom_bar(
        fill = "#6d1e3b", 
        colour = "white"
    ) + 
    coord_flip()
``` 
]

---
## Non-normally distributed data

.pull-left[
```{r lot_area_plot_code, eval = FALSE}
ames %>% 
    ggplot(aes(x = Lot_Area)) + 
    geom_density() + 
    xlim(0, 30000)
```    
]

.pull-right[
```{r lot_area_plot, warning = FALSE, echo = FALSE, dpi = 300, out.height = 420, out.width = 420}
ames %>% 
    ggplot(aes(x = Lot_Area)) + 
    geom_density() + 
    xlim(0, 30000)
``` 
]

---
## Preparing and baking a recipe

```{r data_split, message = FALSE, warning = FALSE}
library(rsample)
data_split <- initial_split(ames, strata = "Sale_Price", p = 0.75)
ames_train <- training(data_split)
ames_test <- testing(data_split)
```

--

```{r recipe}
recipe(
        Sale_Price ~ Longitude + Latitude + Neighborhood + Lot_Area, 
        data = ames_train
    ) %>% 
    step_other(Neighborhood, threshold = 0.05) %>%
    step_log(Sale_Price, base = 10) %>%
    step_YeoJohnson(Lot_Area) %>% 
    prep(training = ames_train) -> ames_recipe
```

--

```{r recipe_baking}
ames_train_baked <- ames_recipe %>% bake(ames_train)
ames_test_baked <- ames_recipe %>% bake(ames_test)
```

---
## Linear models

```{r ames_lms, include = FALSE}
ames_lm <- lm(
    Sale_Price ~ Longitude + Latitude + Neighborhood + Lot_Area,
    data = ames_train
)

ames_baked_lm <- lm(
    Sale_Price ~ Longitude + Latitude + Neighborhood + Lot_Area,
    data = ames_train_baked
)
```

.pull-left[
```{r ames_unmodified_lm, warning = FALSE, message = FALSE, echo = FALSE, dpi = 300, out.height = 420, out.width = 420}
ames_lm %>% ggplot(aes(.fitted, .resid)) +
    geom_hline(yintercept = 0) +
    geom_point() +
    geom_smooth(se = FALSE) +
    xlim(0, 400000) + 
    ggtitle("Unmodified data")
```
]

.pull-right[
```{r ames_modified_lm, warning = FALSE, message = FALSE, echo = FALSE, dpi = 300, out.height = 420, out.width = 420}
ames_baked_lm %>% ggplot(aes(.fitted, .resid)) +
    geom_hline(yintercept = 0) +
    geom_point() +
    geom_smooth(se = FALSE) +
    ggtitle("Modified data")
```
]

---
class: inverse, middle, center

# Missing value imputation

<img src = "missing_value_imputation.jpg" style="width: 30%; height: 30%;"></img>

---
class: middle, center
## Visualising missing data

<img src = "feed_vis_dat.jpg" style="width: 65%; height: 65%;"></img>

---
## Ozone data

.pull-left[
```{r naniar_code, eval = FALSE}
library(naniar)
ozone <- read_csv("ozoneNA.csv") %>% 
    select(-X1, -WindDirection)
vis_miss(ozone)
```
]

.pull-right[
```{r naniar_plot, warning = FALSE, message = FALSE, echo = FALSE, dpi = 300, out.height = 420, out.width = 420}
library(naniar)
ozone <- read_csv("data/ozoneNA.csv") %>% 
    select(-X1, -WindDirection)
vis_miss(ozone, cluster = TRUE)
```
]

---
class: center, middle

<img src="hex/shiny.png" style="width: 50%; height: 50%;"></img>

---
class: left, middle

<img src="docker.png" style="width: 100%; height: 100%;"></img>  
